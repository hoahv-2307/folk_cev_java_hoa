<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
</head>

<body>
    <!-- Add Food Modal Fragment -->
    <div class="modal fade" id="addFoodModal" tabindex="-1" th:fragment="add-food-modal(food)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" th:if="${food == null}">
                        <i class="fas fa-plus me-2"></i>Add New Food
                    </h5>
                    <h5 class="modal-title" th:if="${food != null}">
                        <i class="fas fa-edit me-2"></i>Edit Food
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addFoodForm"
                        th:action="${food != null} ? @{/api/foods/{id}(id=${food.id})} : @{/api/foods}"
                        th:method="${food != null} ? 'put' : 'post'" enctype="multipart/form-data">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <input type="hidden" name="id" th:if="${food != null}" th:value="${food.id}" />

                        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none"
                            id="foodFormError">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        <div class="mb-3">
                            <label for="foodName" class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="foodName" name="name"
                                th:value="${food != null} ? ${food.name} : ''" required />
                        </div>

                        <div class="mb-3">
                            <label for="foodDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="foodDescription" name="description" rows="3"
                                th:text="${food != null} ? ${food.description} : ''"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="foodCategory" class="form-label">Category <span
                                    class="text-danger">*</span></label>
                            <select class="form-select" id="foodCategory" name="category" required>
                                <option value="">Select category</option>
                                <option value="Italian" th:selected="${food != null and food.category == 'Italian'}">
                                    Italian
                                </option>
                                <option value="American" th:selected="${food != null and food.category == 'American'}">
                                    American
                                </option>
                                <option value="Japanese" th:selected="${food != null and food.category == 'Japanese'}">
                                    Japanese
                                </option>
                                <option value="Mexican" th:selected="${food != null and food.category == 'Mexican'}">
                                    Mexican
                                </option>
                                <option value="Indian" th:selected="${food != null and food.category == 'Indian'}">
                                    Indian
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="foodPrice" class="form-label">Price ($) <span
                                    class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="foodPrice" name="price" step="0.01" min="0"
                                th:value="${food != null} ? ${food.price} : ''" required />
                        </div>

                        <div class="mb-3">
                            <label for="foodImages" class="form-label">Food Images</label>
                            <input type="file" class="form-control" id="foodImages" name="foodImages" multiple
                                accept="image/*" />
                            <div class="form-text" th:if="${food == null}">
                                Upload one or more images for this food item. Accepted formats: JPG, PNG, GIF
                            </div>
                            <div class="form-text" th:if="${food != null}">
                                <strong>Note:</strong> Uploading new images will replace all existing images. Leave empty to keep current images.
                            </div>
                            <div id="imagePreviewContainer" class="mt-3">
                                <div class="row g-2" id="currentImages" th:if="${food != null and food.foodImages != null and !food.foodImages.isEmpty()}">
                                    <div class="col-12">
                                        <h6 class="text-muted mb-2">
                                            <i class="fas fa-images me-1"></i>Current Images 
                                            <span class="badge bg-info" th:text="${#lists.size(food.foodImages)}">0</span>
                                        </h6>
                                    </div>
                                    <div class="col-md-4" th:each="image : ${food.foodImages}">
                                        <div class="position-relative">
                                            <img th:src="@{/api/foods/images/{filename}(filename=${image.imageUrl})}" 
                                                 class="img-thumbnail" 
                                                 alt="Food image" 
                                                 style="width: 100%; height: 150px; object-fit: cover;">
                                            <span class="badge bg-primary position-absolute top-0 start-0 m-1">
                                                <i class="fas fa-check me-1"></i>Current
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-2 mt-2" id="newImagePreviews"></div>
                            </div>
                        </div>
                        <script>
                            (function() {
                                const imageInput = document.getElementById('foodImages');
                                const previewContainer = document.getElementById('newImagePreviews');
                                const currentImagesContainer = document.getElementById('currentImages');
                                
                                if (imageInput) {
                                    imageInput.addEventListener('change', function(e) {
                                        previewContainer.innerHTML = '';
                                        const files = e.target.files;
                                        
                                        if (files.length > 0) {
                                            // Add header for new images
                                            const headerCol = document.createElement('div');
                                            headerCol.className = 'col-12';
                                            headerCol.innerHTML = `
                                                <h6 class="text-muted mb-2">
                                                    <i class="fas fa-upload me-1"></i>New Images (${files.length})
                                                </h6>
                                                <div class="alert alert-info py-2 mb-2">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    These images will replace all existing images when you save.
                                                </div>
                                            `;
                                            previewContainer.appendChild(headerCol);
                                        }
                                        
                                        Array.from(files).forEach((file, index) => {
                                            if (file.type.startsWith('image/')) {
                                                const reader = new FileReader();
                                                
                                                reader.onload = function(event) {
                                                    const col = document.createElement('div');
                                                    col.className = 'col-md-4';
                                                    
                                                    const imgContainer = document.createElement('div');
                                                    imgContainer.className = 'position-relative';
                                                    
                                                    const img = document.createElement('img');
                                                    img.src = event.target.result;
                                                    img.className = 'img-thumbnail';
                                                    img.alt = 'Preview';
                                                    img.style.width = '100%';
                                                    img.style.height = '150px';
                                                    img.style.objectFit = 'cover';
                                                    
                                                    const badge = document.createElement('span');
                                                    badge.className = 'badge bg-success position-absolute top-0 start-0 m-1';
                                                    badge.innerHTML = '<i class="fas fa-plus me-1"></i>New';
                                                    
                                                    imgContainer.appendChild(img);
                                                    imgContainer.appendChild(badge);
                                                    col.appendChild(imgContainer);
                                                    previewContainer.appendChild(col);
                                                };
                                                
                                                reader.readAsDataURL(file);
                                            }
                                        });
                                    });
                                }
                            })();
                        </script>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="submit" form="addFoodForm" class="btn btn-primary" th:if="${food == null}">
                        <i class="fas fa-save me-2"></i>Add Food
                    </button>
                    <button type="submit" form="addFoodForm" class="btn btn-primary" th:if="${food != null}">
                        <i class="fas fa-save me-2"></i>Update Food
                    </button>
                </div>
            </div>
        </div>
        <script>
            (function () {
                const form = document.getElementById("addFoodForm");

                if (form) {
                    form.addEventListener("submit", function (e) {
                        e.preventDefault();

                        const submitBtn = document.querySelector(
                            'button[form="addFoodForm"]',
                        );
                        const formData = new FormData(form);
                        const actionUrl = form.action;

                        submitBtn.disabled = true;
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML =
                            '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                        const methodInput = form.querySelector('input[name="_method"]');
                        const method =
                            methodInput != null ? methodInput.value.toUpperCase() : "POST";

                        $.ajax({
                            url: actionUrl,
                            method: method,
                            data: formData,
                            processData: false,
                            contentType: false,
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                            },
                            success: function (response) {
                                const modalEl = document.getElementById("addFoodModal");
                                const modal =
                                    bootstrap.Modal.getInstance(modalEl) ||
                                    new bootstrap.Modal(modalEl);
                                modal.hide();

                                showToast(
                                    "Food " +
                                    (formData.get("id") ? "updated" : "added") +
                                    " successfully!",
                                    "success",
                                );

                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            },
                            error: function (xhr, status, error) {
                                const errorMsg =
                                    xhr.responseJSON && xhr.responseJSON.message
                                        ? xhr.responseJSON.message
                                        : "An error occurred while processing your request.";
                                const errorDiv = $("#foodFormError");
                                errorDiv.attr("visible", "true");
                                errorDiv.find("span").text(errorMsg);
                                errorDiv.show();
                            },
                            complete: function () {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalText;
                            },
                        });
                    });
                }
            })();
        </script>
    </div>

</body>

</html>