<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <div th:replace="~{fragments/common/common-libs-script :: common-head('Food Menu - Foods App')}"></div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <div th:replace="~{fragments/user/user-styles :: user-styles}"></div>
</head>
<body>
    <div th:replace="~{fragments/user/user-header :: user-header}"></div>

    <div class="container mt-4">
        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/foods">Foods</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </nav>
                <h2 class="mb-0">
                    <i class="fas fa-credit-card me-2"></i>Checkout
                </h2>
            </div>
        </div>

        <div class="row">
            <!-- Order Summary -->
            <div class="col-lg-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-shopping-basket me-2"></i>Order Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${#lists.isEmpty(cart.items)}" class="text-center py-4">
                            <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Your cart is empty</h5>
                            <a href="/foods" class="btn btn-primary">
                                <i class="fas fa-utensils me-2"></i>Browse Foods
                            </a>
                        </div>

                        <div th:if="${!#lists.isEmpty(cart.items)}">
                            <div class="row" th:each="item : ${cart.items}">
                                <div class="col-12 mb-3">
                                    <div class="d-flex align-items-center border-bottom pb-3">
                                        <!-- Food Image -->
                                        <div class="me-3">
                                            <div th:if="${!#lists.isEmpty(item.foodImageUrls)}" class="position-relative">
                                                <img th:src="@{/api/foods/images/{filename}(filename=${item.foodImageUrls[0]})}" 
                                                     class="rounded img-thumbnail" 
                                                     alt="Food image" 
                                                     style="width: 80px; height: 80px; object-fit: cover;">
                                            </div>
                                            <div th:if="${#lists.isEmpty(item.foodImageUrls)}" 
                                                 class="d-flex align-items-center justify-content-center bg-light rounded border" 
                                                 style="width: 80px; height: 80px;">
                                                <i class="fas fa-utensils text-muted fa-2x"></i>
                                            </div>
                                        </div>

                                        <!-- Food Details -->
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold" th:text="${item.foodName}">Food Name</h6>
                                            <p class="text-muted mb-1 small">Delicious food item</p>
                                        </div>

                                        <!-- Quantity and Price -->
                                        <div class="text-end">
                                            <div class="mb-1">
                                                <span class="text-muted small">Quantity: </span>
                                                <span class="fw-bold" th:text="${item.quantity}">0</span>
                                            </div>
                                            <div class="mb-1">
                                                <span class="text-muted small">Unit Price: </span>
                                                <span class="fw-bold text-success" th:text="'$' + ${item.foodPrice}">$0.00</span>
                                            </div>
                                            <div>
                                                <span class="text-muted small">Subtotal: </span>
                                                <span class="fw-bold text-primary" th:text="'$' + ${item.subtotal}">$0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkout Panel -->
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 2rem;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-receipt me-2"></i>Order Total
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Order Summary -->
                        <div class="d-flex justify-content-between mb-2">
                            <span>Items:</span>
                            <span th:text="${#lists.size(cart.items)}">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <span th:text="'$' + ${cart.totalAmount}">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax (8%):</span>
                            <span th:text="'$' + ${#numbers.formatDecimal(cart.totalAmount * 0.08, 1, 2)}">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Fee:</span>
                            <span th:text="${cart.totalAmount >= 25} ? 'FREE' : '$2.99'">\$2.99</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <strong>Total:</strong>
                            <strong class="text-success" 
                                    th:text="'$' + ${#numbers.formatDecimal(cart.totalAmount * 1.08 + (cart.totalAmount >= 25 ? 0 : 2.99), 1, 2)}">$0.00</strong>
                        </div>

                        <!-- Delivery Info -->
                        <div class="alert alert-info small" th:if="${cart.totalAmount < 25}">
                            <i class="fas fa-info-circle me-1"></i>
                            Add <span th:text="'$' + ${#numbers.formatDecimal(25 - cart.totalAmount, 1, 2)}">$0.00</span> more for free delivery!
                        </div>
                        <div class="alert alert-success small" th:if="${cart.totalAmount >= 25}">
                            <i class="fas fa-check-circle me-1"></i>
                            You qualify for free delivery!
                        </div>

                        <!-- Checkout Form -->
                        <form id="checkout-form" th:action="@{/checkout}" method="post" th:if="${!#lists.isEmpty(cart.items)}">
                            <!-- CSRF Token -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <!-- Customer Info Display -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Delivery Information</h6>
                                <div class="bg-light p-2 rounded">
                                    <div class="small">
                                        <strong>Customer:</strong> <span th:text="${user.username}">Username</span><br>
                                        <strong>Email:</strong> <span th:text="${user.email}">email@example.com</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Method -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Payment Method</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="cash" value="cash" checked onchange="togglePaymentMethod()">
                                    <label class="form-check-label" for="cash">
                                        <i class="fas fa-money-bill-wave me-1"></i> Cash on Delivery
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card" onchange="togglePaymentMethod()">
                                    <label class="form-check-label" for="card">
                                        <i class="fas fa-credit-card me-1"></i> Credit Card
                                    </label>
                                </div>
                            </div>

                            <!-- Stripe Card Element -->
                            <div id="card-section" class="mb-3" style="display: none;">
                                <h6 class="text-muted mb-2">Card Details</h6>
                                <div id="card-element" class="form-control" style="height: 40px; padding: 10px;">
                                    <!-- Stripe Elements will create form elements here -->
                                </div>
                                <div id="card-errors" class="text-danger mt-1" role="alert"></div>
                            </div>

                            <!-- Hidden field for payment intent ID -->
                            <input type="hidden" name="paymentIntentId" id="paymentIntentId" />

                            <!-- Place Order Button -->
                            <button type="submit" id="submit-button" class="btn btn-success btn-lg w-100 mb-2">
                                <span id="button-text">
                                    <i class="fas fa-check me-2"></i>Place Order
                                </span>
                                <div id="spinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></div>
                            </button>
                        </form>

                        <!-- Back to Cart -->
                        <a href="/foods" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <div th:replace="~{fragments/user/user-scripts}"></div> -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Stripe configuration
        let stripe;
        let elements;
        let cardElement;
        let paymentIntentId = null;

        // Initialize Stripe when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Get Stripe publishable key
                const response = await fetch('/api/payments/config');
                const config = await response.json();
                
                // Initialize Stripe
                stripe = Stripe(config.publishableKey);
                elements = stripe.elements();

                // Create card element
                cardElement = elements.create('card', {
                    hidePostalCode: true,
                    style: {
                        base: {
                            fontSize: '16px',
                            color: '#424770',
                            '::placeholder': {
                                color: '#aab7c4',
                            },
                        },
                        invalid: {
                            color: '#9e2146',
                        },
                    },
                });

                cardElement.mount('#card-element');

                // Handle real-time validation errors
                cardElement.on('change', function(event) {
                    const displayError = document.getElementById('card-errors');
                    if (event.error) {
                        displayError.textContent = event.error.message;
                    } else {
                        displayError.textContent = '';
                    }
                });

            } catch (error) {
                console.error('Error initializing Stripe:', error);
                showToast('Failed to initialize payment system', 'error');
            }
        });

        // Toggle payment method display
        function togglePaymentMethod() {
            const cardSection = document.getElementById('card-section');
            const cardRadio = document.getElementById('card');
            
            if (cardRadio.checked) {
                cardSection.style.display = 'block';
            } else {
                cardSection.style.display = 'none';
                // Clear any existing payment intent if switching from card to cash
                if (paymentIntentId) {
                    cancelPaymentIntent();
                }
            }
        }

        // Calculate total amount in cents
        function getTotalAmountInCents() {
            const cartTotal = [[${cart.totalAmount}]];
            const tax = cartTotal * 0.08;
            const deliveryFee = cartTotal >= 25 ? 0 : 2.99;
            return Math.round((cartTotal + tax + deliveryFee) * 100);
        }

        // Create payment intent
        async function createPaymentIntent() {
            try {
                const response = await fetch('/api/payments/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        amount: getTotalAmountInCents(),
                        currency: 'usd',
                        description: 'Food order payment',
                        receiptEmail: '[[${user.email}]]'
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create payment intent');
                }

                const paymentIntent = await response.json();
                paymentIntentId = paymentIntent.paymentIntentId;
                return paymentIntent.clientSecret;

            } catch (error) {
                console.error('Error creating payment intent:', error);
                throw new Error('Failed to initialize payment');
            }
        }

        // Cancel payment intent
        async function cancelPaymentIntent() {
            if (!paymentIntentId) return;
            
            try {
                await fetch(`/api/payments/cancel/${paymentIntentId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                paymentIntentId = null;
            } catch (error) {
                console.error('Error canceling payment intent:', error);
            }
        }

        // Handle form submission
        document.getElementById('checkout-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            // Disable submit button and show loading
            submitButton.disabled = true;
            buttonText.style.display = 'none';
            spinner.style.display = 'inline-block';

            try {
                if (paymentMethod === 'card') {
                    await handleCardPayment();
                } else {
                    await handleCashPayment();
                }
            } catch (error) {
                console.error('Payment error:', error);
                showToast(error.message || 'Payment failed. Please try again.', 'error');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                buttonText.style.display = 'inline-block';
                spinner.style.display = 'none';
            }
        });

        // Handle card payment
        async function handleCardPayment() {
            // Create payment intent
            const clientSecret = await createPaymentIntent();

            // Confirm payment with Stripe
            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: {
                        name: '[[${user.username}]]',
                        email: '[[${user.email}]]',
                    },
                }
            });

            if (error) {
                // Payment failed
                throw new Error(error.message);
            } else if (paymentIntent.status === 'succeeded') {
                // Payment succeeded - submit form
                document.getElementById('paymentIntentId').value = paymentIntent.id;
                document.getElementById('checkout-form').submit();
            } else {
                throw new Error('Payment was not completed successfully');
            }
        }

        // Handle cash payment
        async function handleCashPayment() {
            // For cash payments, just submit the form
            document.getElementById('checkout-form').submit();
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            // Reuse the toast function from user-scripts if available
            if (typeof window.showToast === 'function') {
                window.showToast(message, type);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>